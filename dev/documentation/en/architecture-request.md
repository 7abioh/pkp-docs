# Request Lifecycle

HTTP requests are routed to a `Handler` which responds to the request. The `Handler` coordinates other classes to authenticate requests, fetch data and format the response.

... diagram ...

## Routes

Each request is mapped to a Page, API or Controller `Handler` based on the URL.

### Page Routes

The diagram below shows a URL for a Page `Handler`.

![Diagram indicating the parts of a URL for Page Handlers](../img/url-route-page.png)

The router will look for a file at `/pages/index.php` or `/lib/pkp/pages/index.php` which loads the correct handler.

```php
switch ($op) {
	case 'view':
		define('HANDLER_CLASS', 'IssueHandler');
		import('pages.issue.IssueHandler');
		break;
}
```

All `op`s for a page are usually managed by the same `Handler`. However, it is possible to direct each `op` to a different handler.

```php
switch ($op) {
	case 'view':
		define('HANDLER_CLASS', 'IssueHandler');
		import('pages.issue.IssueHandler');
		break;
	case 'archive':
		define('HANDLER_CLASS', 'ArchiveHandler');
		import('pages.issue.ArchiveHandler');
		break;
}
```

This is not possible for API or Controller routes.

### API Routes

The diagram below shows a URL for an API `Handler`.

![Diagram indicating the parts of a URL for API Handlers](../img/url-route-api.png)

The router will look for a file at `/api/v1/submissions/index.php` which loads the correct handler.

```php
import('api.v1.submissions.SubmissionsHandler');
return new SubmissionsHandler();
```

The router will **not** find a file at `/lib/pkp/api/v1/submissions/index.php`.

### Controller Routes

The diagram below shows a URL for a [Controller `Handler`](architecture-handlers#controller-handlers).

![Diagram indicating the parts of a URL for Controller Handlers](../img/url-route-controller.png)

The router will look for and load a `Handler` at `/controllers/grid/issues/BackIssueGridHandler.inc.php`.

Controller URLs are derived from the `Handler` class name. The `Handler` suffix is dropped and the remaining name is transformed from `CamelCase` to `kebab-case`.

## Writing URLs

Never manually write a URL path because the application can be run without the URL routing enabled. When the [config](./utilities-config.md) option `disable_path_info` is turned on, URL routing will use query parameters.

```
http://example.org/?journal=publicknowledge&page=issue&op=view&path[]=1
```

URLs should always be generated by the `Router`'s `url` method. You can retrieve the appropriate `Router` from the `Request` object.

```php
$url = $request->getRouter()->url($request, null, 'issue', 'view', 1);
```

*A `Handler` will receive the `Request` object. See [Request Handlers](./architecture-handlers).*

The `Request` object will always return a `Router` type which matches the current route and generates URLs for that type. In a Page Handler it will return a `PageRouter`.

```php
$pageUrl = $request->getRouter()->url($request, null, 'issue', 'view', 1);
```

In an API Handler it will return an `APIRouter`.

```php
$apiUrl = $request->getRouter()->url($request, null, 'issues/1');
```

In a Controller Handler it will return a `PKPComponentRouter`.

```php
$controllerUrl = $request->getRouter()->url($request, null, 'grid.issues.IssueGridHandler', 'editIssue', [1]);
```

If you need to get a URL for a different router, use the `Dispatcher`.

```php
$pageUrl = $request->getDispatcher()->url($request, ROUTE_PAGE, 'issue', 'view', 1);
$apiUrl = $request->getDispatcher()->url($request, ROUTE_API, $context->getPath(), 'issues/1');
$controllerUrl = $request->getDispatcher()->url($request, ROUTE_COMPONENT, null, 'grid.issues.IssueGridHandler', 'editIssue', [1]);
```


## Page Handlers

Page Handlers return `HTML` output and should be used to render a complete webpage.

```php
import('classes.handler.Handler');
class IssueHandler extends Handler {
	/**
	 * Display the table of contents for the current issue
	 */
	public function current($args, $request) {
		return '<html>...</html>';
	}
}
```

Requests are routed to a Page Handler when a corresponding `index.php` file is found at `/pages`. A request to `http://example.org/publicknowledge/issues/current` will look for the following file at `/pages/issues/index.php`.

```php
switch ($op) {
	case 'current':
		define('HANDLER_CLASS', 'IssueHandler');
		import('pages.issue.IssueHandler');
		break;
}
```

The routing `index.php` file may also be located at `/lib/pkp/pages/issues/index.php`.

### Page route parameters

The URL to a page may include several parameters.


Page Handlers may define an `index` op to handle URLs without a second statement.

```php
import('classes.handler.Handler');
class IssueHandler extends Handler {
	/**
	 * Display a list of all issues
	 */
	public function index($args, $request) {
		return '<html>...</html>';
	}
}
```

```php
switch ($op) {
	// Handles HTTP request to <base-url>/issues
	case 'index':
		define('HANDLER_CLASS', 'IssueHandler');
		import('pages.issue.IssueHandler');
		break;
}
```

### Route requests to different handlers

The routing `index.php` file may route requests to more than one handler when required.

```php
switch ($op) {
	case 'index':
		define('HANDLER_CLASS', 'IssueHandler');
		import('pages.issue.IssueHandler');
		break;
	case 'archive':
		define('HANDLER_CLASS', 'ArchiveHandler');
		import('pages.issue.ArchiveHandler');
		break;
}
```

### Request Object

The `Request` object will store additional URL path information. Consider a request to `<baseurl>/issue/archives/1`.

```php
class IssueHandler extends Handler {
	public function archives($args, $request) {
		$page = $request->getRequestedPage(); // issue
		$op = $request->getRequestedOp(); // archives
		$path = $request->getRequestedPath(); // 1
		return '<html>...</html>';
	}
}
```





/**
 * Display current issue page.
 */
function current($args, $request) {
	$journal = $request->getJournal();
	$issueDao = DAORegistry::getDAO('IssueDAO');
	$issue = $issueDao->getCurrent($journal->getId(), true);

	if ($issue != null) {
		$request->redirect(null, 'issue', 'view', $issue->getBestIssueId());
	}

	$this->setupTemplate($request);
	$templateMgr = TemplateManager::getManager($request);
	// consider public identifiers
	$pubIdPlugins = PluginRegistry::loadCategory('pubIds', true);
	$templateMgr->assign('pubIdPlugins', $pubIdPlugins);
	$templateMgr->display('frontend/pages/issue.tpl');
}

Page Handlers are located in the `/pages` and `/lib/pkp/pages` directory. Requests are routed to a `PageHandler` when a corresponding handler



Common examples of a `PageHandler` include an issue's table of contents page, the login page such as an issue's table of content

return `HTML`

page / op / path


PKP supports [`PageHandlers`](./architecture-handlers#pagehandler), [`APIHandlers`](./architecture-handlers#apihandler) and [`Controllers`](./architecture-handlers#controllers).


In progress.

Description of a request lifecycle from request to response (include diagram).
